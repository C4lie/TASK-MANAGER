<!-- tasks/templates/tasks/home.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center">Task Manager</h1>
        <div id="task-list" class="mt-4"></div>
        <a href="{% url 'tasks:add_task' %}" class="btn btn-primary">Add Task</a>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        console.log('Task Data:', taskData);
        $(document).ready(function () {
            
            // Fetch tasks and render them
            function loadTasks() {
                $.ajax({
                    url: '/api/tasks/',
                    type: 'GET',
                    success: function (response) {
                        let taskList = '';
                        response.forEach(task => {
                            taskList += `
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h5>${task.title}</h5>
                                        <p>${task.description}</p>
                                        <a href="/tasks/detail/${task.id}" class="btn btn-info">View</a>
                                    </div>
                                </div>`;
                        });
                        $('#task-list').html(taskList);
                    },
                    error: function () {
                        alert('Error loading tasks!');
                    }
                });
            }

            // Load tasks initially
            loadTasks();

            // Handle task form submission
            $('#task-form').on('submit', function (e) {
                e.preventDefault(); // Prevent the default form submission

                // Get form data
                const taskData = {
                    title: $('#title').val(),
                    description: $('#description').val(),
                    due_date: $('#due_date').val(),
                    priority: $('#priority').val(),
                };

                // Send data to the backend
                $.ajax({
                    url: '/api/tasks/', // Endpoint for creating a task
                    type: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken') // Ensure CSRF token is included
                    },
                    data: taskData,
                    success: function (response) {
                        alert('Task added successfully!');
                        loadTasks(); // Refresh the task list
                        window.location.href = '/'; // Redirect to the home page
                    },
                    error: function () {
                        alert('Error adding task!');
                    }
                });
            });

            // Helper function to get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });

    </script>
</body>
</html>
